# ============================================================================
# N8N Docker Makefile
# ============================================================================
# Vereinfacht hÃ¤ufige Docker-Operationen
# Verwendung: make [target]
# ============================================================================

.PHONY: help start stop restart logs status backup clean update test

# Standard-Ziel: Hilfe anzeigen
help:
	@echo "========================================="
	@echo "N8N Docker Management"
	@echo "========================================="
	@echo ""
	@echo "VerfÃ¼gbare Befehle:"
	@echo ""
	@echo "  make start       - Container starten"
	@echo "  make stop        - Container stoppen"
	@echo "  make restart     - Container neu starten"
	@echo "  make logs        - Logs anzeigen (live)"
	@echo "  make logs-n8n    - Nur N8N Logs"
	@echo "  make logs-db     - Nur PostgreSQL Logs"
	@echo "  make status      - Container-Status anzeigen"
	@echo "  make backup      - Backup erstellen"
	@echo "  make clean       - Container stoppen & entfernen"
	@echo "  make clean-all   - Container + Volumes entfernen (ACHTUNG!)"
	@echo "  make update      - Images aktualisieren"
	@echo "  make test        - Verbindungstest durchfÃ¼hren"
	@echo "  make shell-n8n   - Shell in N8N Container"
	@echo "  make shell-db    - Shell in PostgreSQL Container"
	@echo ""

# Container starten
start:
	@echo "ğŸš€ Starte N8N Container..."
	docker-compose up -d
	@echo "âœ… Container gestartet!"
	@echo ""
	@echo "Zugriff:"
	@echo "  https://MAC-PRO-INTEL.local:5678"
	@echo "  https://10.0.0.171:5678"
	@echo ""

# Container stoppen
stop:
	@echo "â¸ï¸  Stoppe Container..."
	docker-compose stop
	@echo "âœ… Container gestoppt!"

# Container neu starten
restart:
	@echo "ğŸ”„ Starte Container neu..."
	docker-compose restart
	@echo "âœ… Container neu gestartet!"

# Logs anzeigen
logs:
	docker-compose logs -f

# N8N Logs
logs-n8n:
	docker-compose logs -f n8n

# PostgreSQL Logs
logs-db:
	docker-compose logs -f postgres

# Status anzeigen
status:
	@echo "ğŸ“Š Container Status:"
	@echo ""
	docker-compose ps
	@echo ""
	@echo "ğŸ¥ Health Status:"
	@docker inspect n8n-app --format='N8N: {{.State.Health.Status}}' 2>/dev/null || echo "N8N: Container nicht gefunden"
	@docker inspect n8n-postgres --format='PostgreSQL: {{.State.Health.Status}}' 2>/dev/null || echo "PostgreSQL: Container nicht gefunden"

# Backup erstellen
backup:
	@echo "ğŸ’¾ Erstelle Backup..."
	./backup.sh

# Container cleanup
clean:
	@echo "ğŸ§¹ Entferne Container..."
	docker-compose down
	@echo "âœ… Container entfernt (Daten bleiben erhalten)"

# VollstÃ¤ndiges Cleanup (inkl. Volumes)
clean-all:
	@echo "âš ï¸  WARNUNG: Dieser Befehl lÃ¶scht ALLE Daten!"
	@echo "Abbruch mit Ctrl+C mÃ¶glich..."
	@sleep 5
	docker-compose down -v
	@echo "âœ… Container und Volumes entfernt"

# Images aktualisieren
update:
	@echo "ğŸ“¥ Lade neue Images..."
	docker-compose pull
	@echo "ğŸ”„ Starte Container mit neuen Images..."
	docker-compose up -d
	@echo "ğŸ—‘ï¸  Entferne alte Images..."
	docker image prune -f
	@echo "âœ… Update abgeschlossen!"

# Verbindungstest
test:
	@echo "ğŸ§ª Teste Verbindungen..."
	@echo ""
	@echo "Testing localhost..."
	@curl -k -s -o /dev/null -w "  Status: %{http_code}\n" https://localhost:5678/healthz
	@echo ""
	@echo "Testing IP (10.0.0.171)..."
	@curl -k -s -o /dev/null -w "  Status: %{http_code}\n" https://10.0.0.171:5678/healthz
	@echo ""
	@echo "Testing Hostname..."
	@curl -k -s -o /dev/null -w "  Status: %{http_code}\n" https://MAC-PRO-INTEL.local:5678/healthz
	@echo ""
	@echo "âœ… Tests abgeschlossen (200 = OK, 401 = Basic Auth aktiv)"

# Shell in N8N Container
shell-n8n:
	docker-compose exec n8n /bin/sh

# Shell in PostgreSQL Container
shell-db:
	docker-compose exec postgres /bin/bash

# PostgreSQL Kommandozeile
psql:
	docker-compose exec postgres psql -U n8n_user -d n8n
